package com.master.vulnerabilitychecker.service;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.ObjectWriter;
import com.master.vulnerabilitychecker.dto.RepositoryDTO;
import com.master.vulnerabilitychecker.dto.VulnerabilityDTO;
import com.master.vulnerabilitychecker.model.Dependency;
import com.master.vulnerabilitychecker.model.Vulnerability;
import com.master.vulnerabilitychecker.model.Repository;
import com.master.vulnerabilitychecker.model.builder.VulnerabilityBuilder;
import com.master.vulnerabilitychecker.model.ids.VulnerabilityId;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;
import com.master.vulnerabilitychecker.client.NVDClient;

import java.util.HashMap;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;

@Service
public class NVDService {

    private NVDClient nvdClient;
    private GithubRepositoryService githubRepositoryService;
    private VulnerabilityService vulnerabilityService;
    // mapa sadrzi putanje iz JSON seme
    private final Map<String, String> paths = new HashMap<String, String>() {
        {
            put("cveItems", "/result/CVE_Items");
            put("cveId", "/cve/CVE_data_meta/ID");
            put("description", "/cve/description/description_data");
            put("descriptionValue", "/value");
            put("references", "/cve/references/reference_data");
            put("referenceUrl", "/url");
            put("impactV2", "/impact/baseMetricV2");
            put("impactV3", "/impact/baseMetricV3");
            put("severityV3", "/cvssV3/baseSeverity");
            put("severityV2", "/severity");
        }
    };

    public NVDService(NVDClient nvdClient, GithubRepositoryService githubRepositoryService, VulnerabilityService vulnerabilityService) {
        this.nvdClient = nvdClient;
        this.githubRepositoryService = githubRepositoryService;
        this.vulnerabilityService = vulnerabilityService;
    }

    public void keywordSearch(List<String> dependencies, Repository repository) throws JsonProcessingException {
        for(String keyword: dependencies){
            ResponseEntity responseEntity = nvdClient.keywordSearch(keyword);
            mapVulnaribilities(responseEntity, keyword, repository);
        }
    }

    private void mapVulnaribilities(ResponseEntity responseEntity, String keyword, Repository repository) throws JsonProcessingException {
        VulnerabilityDTO vulnerabilityDTO = new VulnerabilityDTO();
        vulnerabilityDTO.setName(keyword);
        vulnerabilityDTO.setRepositoryDTO(new RepositoryDTO(repository));
        ObjectWriter ow = new ObjectMapper().writer().withDefaultPrettyPrinter();
        ObjectMapper mapper = new ObjectMapper();
        String json = ow.writeValueAsString(responseEntity.getBody());
        JsonNode tree = mapper.readTree(json);
        JsonNode cveItems = tree.at(paths.get("cveItems"));

        cveItems.forEach(
                node -> {
                    try {

                        String cveId = mapper.treeToValue(node.at(paths.get("cveId")), String.class);
                        JsonNode descriptionNode = node.at(paths.get("description")).get(0);
                        String descriptionValue = mapper.treeToValue(descriptionNode.at(paths.get("descriptionValue")), String.class);
                        vulnerabilityDTO.setCveId(cveId);
                        vulnerabilityDTO.setDescription(descriptionValue);
                        vulnerabilityDTO.setInfoUrl(cveId);

                        JsonNode impactV2 = node.at(paths.get("impactV2"));
                        JsonNode impactV3 = node.at(paths.get("impactV3"));
                        if(!impactV2.isEmpty()){
                            String severityV2 = mapper.treeToValue(impactV2.at(paths.get("severityV2")), String.class);
                            vulnerabilityDTO.setSeverityV2(severityV2);
                        }
                        if(!impactV3.isEmpty()){
                            String severityV3 = mapper.treeToValue(impactV3.at(paths.get("severityV3")), String.class);
                            vulnerabilityDTO.setSeverityV3(severityV3);
                        }

                        node.at(paths.get("references")).forEach(
                                reference -> {
                                    try {
                                        String referenceValue = mapper.treeToValue(reference.at(paths.get("referenceUrl")), String.class);
                                        vulnerabilityDTO.getReferences().add(referenceValue);
                                    } catch (JsonProcessingException e) {
                                        e.printStackTrace();
                                    }
                                }
                        );

                    } catch (JsonProcessingException e) {
                        e.printStackTrace();
                    }

                    Vulnerability vulnerability = new VulnerabilityBuilder()
                                                .id(new VulnerabilityId(vulnerabilityDTO.getCveId(), repository.getId()))
                                                .description(vulnerabilityDTO.getDescription())
                                                .name(vulnerabilityDTO.getName())
                                                .infoUrl(vulnerabilityDTO.getCveId())
                                                .severityV2(vulnerabilityDTO.getSeverityV2())
                                                .severityV3(vulnerabilityDTO.getSeverityV3())
                                                .referenceUrls(vulnerabilityDTO.getReferences())
                                                .build();
                    vulnerability = vulnerabilityService.save(vulnerability);
                    vulnerability.setRepository(repository);
                    vulnerability = vulnerabilityService.save(vulnerability);
                }
        );
    }

    private void mapVulns(ResponseEntity responseEntity, List<VulnerabilityDTO> vulnerabilities) {
        VulnerabilityDTO vulnerabilityDTO = new VulnerabilityDTO();

        LinkedHashMap<String, Object> body = (LinkedHashMap<String, Object>) responseEntity.getBody();
        LinkedHashMap<String, Object> result = (LinkedHashMap<String, Object>) body.get("result");
        if (result == null) return;
        List<LinkedHashMap> cveItems = (List<LinkedHashMap>) result.get("CVE_Items");

        for (LinkedHashMap<String, Object> cveItem : cveItems) {
            LinkedHashMap<String, Object> cve = (LinkedHashMap<String, Object>) cveItem.get("cve");
            LinkedHashMap<String, Object> cveMetaData = (LinkedHashMap<String, Object>) cve.get("CVE_data_meta");
            String cveId = (String) cveMetaData.get("ID");

            LinkedHashMap<String, Object> description = (LinkedHashMap<String, Object>) cve.get("description");
            List<LinkedHashMap> descriptionData = (List<LinkedHashMap>) description.get("description_data");
            String descriptionValue = (String) descriptionData.get(0).get("value");

            LinkedHashMap<String, Object> references = (LinkedHashMap<String, Object>) cve.get("references");
            List<LinkedHashMap> referenceData = (List<LinkedHashMap>) references.get("reference_data");
            for (LinkedHashMap<String, Object> reference : referenceData) {
                vulnerabilityDTO.getReferences().add(String.valueOf(reference.get("url")));
            }

            vulnerabilityDTO.setCveId(cveId);
            vulnerabilityDTO.setDescription(descriptionValue);
            vulnerabilities.add(vulnerabilityDTO);
        }
    }


}
