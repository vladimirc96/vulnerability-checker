import React, { Component } from 'react';
import { Formik, Field, Form, ErrorMessage } from 'formik';
import * as Yup from 'yup';
import repositoryService from '../../service/RepositoryService';
import githubUserService from '../../service/GithubUserService';

class RepositoryForm extends Component{

    constructor(){
        super();
        this.state = { githubUsers: [] }
    }

    componentDidMount(){
        githubUserService.findAll().then(
            data => {
                this.setState({githubUsers: data});
            }
        ).catch(error => alert(error));
    }
    
    handleSubmit = (fields) => {
        console.log(fields)
        repositoryService.addRepo({name: fields.name, ownerName: fields.ownerName}, this.props.addRepository);
    }

    render() {
        let githubUsers = [];
        if(this.state.githubUsers != undefined){
            githubUsers = this.state.githubUsers.map(
                user => { 
                    return (<option key={user.username} value={user.username}>{user.username}</option>) 
                }
            )
        }
        return(
            <div className="col-md-5">
                            <div className="p-5">
                                <Formik 
                                    initialValues={{
                                        ownerName: '',
                                        name: '',
                                    }}
                                    validationSchema={Yup.object().shape({
                                        name: Yup.string()
                                            .required('Name is required'),
                                    })}
                                    onSubmit={fields => this.handleSubmit(fields)}
                                    render={ ({ errors, status, touched}) => (
                                        <Form>
                                             <div className="form-group">
                                                <Field 
                                                    name="name"
                                                    className={'form-control form-control-user' + (errors.name && touched.name ? ' is-invalid' : '')}
                                                    placeholder="Enter repository name..."/>
                                                    <ErrorMessage name="name" component="div" className="invalid-feedback" />
                                            </div>
                                            <div className="form-group">
                                                <Field 
                                                    name="ownerName"
                                                    className="form-control form-control-user"
                                                    component="select"
                                                    placeholder="Choose owner">
                                                    <option selected hidden></option>
                                                    {githubUsers}
                                                </Field>
                                            </div>
                                            <button type="submit" className="btn btn-primary btn-user btn-block">
                                                Submit
                                            </button>
                                        </Form>
                                    ) }
                                />
                            </div>
            </div>
        )
    }



}

export default RepositoryForm;